<!doctype html>
<html>
	<head>
		<meta charset=”UTF-8″>
		<title>μPD777</title>
		<script src="./js/uPD777.js"></script>
	</head>
	<body>
		<div>
			<!-- 画面 -->
			<div id="fs-target">
				<div id="fs-inner" class="canvas-wrapper">
					<canvas id="graphicCanvas" class="graphicsLayer"></canvas>
				</div>
			</div>
		</div>
		<script type="module">
			"use strict";

			// 描画先のキャンパス取得と設定
			const graphicCanvas = document.getElementById("graphicCanvas");
			graphicCanvas.setAttribute("width", 375);
			graphicCanvas.setAttribute("height", 240);
			var graphicCanvasCtx = graphicCanvas.getContext("2d");

			// CPU作成
			var cpu = new uPD777();

			let previousRenderTimestamp;
			let previousTimestamp;
			/**
			 * 更新処理
			 * @param {number} timestamp ミリ秒単位
			 */
			function update(timestamp)
			{
				if (previousRenderTimestamp === undefined) {
					previousRenderTimestamp = timestamp;
					previousTimestamp = timestamp;
				}
				// 前回のフレームからの経過時間(ms)
				const elapsed = timestamp - previousTimestamp;
				previousTimestamp = timestamp;
				// 前回の描画してからの経過時間(ms)
				const renderElapsed = timestamp - previousRenderTimestamp;

                // CPU更新
                // CLOCK input  3.579545 MHz
                // CPU Clock    1.431818 MHz (= 3.579545 MHz / 2.5)
				cpu.update(elapsed * 1431.818);

				// 画面描画
				if(renderElapsed >= 1000/60) {
					previousRenderTimestamp += 1000/60;
					// 画像取得して描画
					cpu.getVRAMImage(graphicCanvasCtx);
				}

				// VSync待ち
				requestAnimationFrame((timestamp)=>update(timestamp));
			}

			// ページ読み込み後に実行される
			window.onload = async function() {
				// セットアップして開始
				cpu.setup("./wasm/uPD777.wasm").then((emu)=>{ update(0); });
			}
		</script>
	</body>
</html>